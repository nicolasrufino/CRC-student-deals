# StuDeals ðŸŽ“

> A student discount discovery and ordering platform â€” web-first, built with Next.js, Supabase, Google Maps, and Stripe.

Students log in with their `.edu` email, see verified discount spots on a live map, order directly from the app (at student prices), and earn rewards for leaving reviews.

---

## Table of Contents

1. [How the App Works â€” Big Picture](#1-how-the-app-works--big-picture)
2. [Tech Stack & Why](#2-tech-stack--why)
3. [Directory Structure](#3-directory-structure)
4. [The Data Layer â€” Database & Types](#4-the-data-layer--database--types)
5. [The Auth System](#5-the-auth-system)
6. [The Map System](#6-the-map-system)
7. [The Ordering System](#7-the-ordering-system)
8. [The Rewards System](#8-the-rewards-system)
9. [Global State â€” Zustand Stores](#9-global-state--zustand-stores)
10. [API Routes â€” Every Endpoint Explained](#10-api-routes--every-endpoint-explained)
11. [Third-Party Integrations](#11-third-party-integrations)
12. [How Files Talk to Each Other â€” Dependency Map](#12-how-files-talk-to-each-other--dependency-map)
13. [Environment Variables](#13-environment-variables)
14. [Build Phases](#14-build-phases)
15. [Getting Started](#15-getting-started)

---

## 1. How the App Works â€” Big Picture

Here is the full user journey from first visit to completed order:

```
User visits studeals.com
        â”‚
        â–¼
  Not logged in?
  â†’ Homepage (app/page.tsx)
  â†’ "Sign in with Google" button
        â”‚
        â–¼
  Google OAuth â†’ Supabase Auth
  â†’ app/auth/callback/route.ts
  â†’ New user? â†’ /onboarding
  â†’ Returning user? â†’ /map
        â”‚
        â–¼
  /onboarding (app/onboarding/page.tsx)
  Step 1: Enter .edu email â†’ verification email sent
  Step 2: Click link in .edu inbox â†’ edu_verified = true
  Step 3: Enter personal email for promos
        â”‚
        â–¼
  /map (app/map/page.tsx)  â† THE CORE EXPERIENCE
  Google Maps loads, markers appear for discount spots
  User can filter by category (Drinks, Coffee, Food...)
  User taps a marker â†’ PlaceDrawer slides up
        â”‚
        â”œâ”€â”€ "Get Directions" â†’ opens Google Maps app with route
        â”‚
        â””â”€â”€ "View Menu & Order"
                â”‚
                â–¼
          /places/[id] (app/places/[id]/page.tsx)
          Menu items shown with student price vs regular price
          User adds items to cart
                â”‚
                â–¼
          Cart â†’ Checkout (Stripe)
          POST /api/orders â†’ PaymentIntent created
          Stripe Elements collects card
          Payment confirmed â†’ Stripe webhook fires
                â”‚
                â–¼
          Order confirmed â†’ submitted to Toast POS
          Restaurant receives order in their system
          User sees confirmation + order history
                â”‚
                â–¼
          User leaves a review
          POST /api/reviews â†’ review saved
          review_count increments
          Every 5 reviews â†’ $5 reward issued
```

---

## 2. Tech Stack & Why

| Layer | Technology | Why This Choice |
|---|---|---|
| **Framework** | Next.js 14 (App Router) | One codebase handles both frontend pages and backend API routes. SSR for SEO on place pages. Deploys to Vercel in one command. |
| **Language** | TypeScript | Catches bugs before runtime. With this many interconnected files, types are non-negotiable. |
| **Database** | PostgreSQL via Supabase | Relational data (users â†’ orders â†’ reviews) needs SQL. Supabase adds a dashboard, real-time, and auth on top for free. |
| **Auth** | Supabase Auth | Google OAuth is built in. Session management via cookies. No auth code to write from scratch. |
| **Styling** | Tailwind CSS | Fast to build with, easy to keep consistent across components. |
| **Maps** | Google Maps JS SDK (`@vis.gl/react-google-maps`) | Industry standard. Integrates with Google Maps app for directions. Reliable marker rendering. |
| **Payments** | Stripe | Most developer-friendly payment API. Handles card storage, PaymentIntents, webhooks, and coupons (for rewards). |
| **Email** | Resend | Transactional email with a clean React-based template system. Used for .edu verification, order confirmations, reward notifications. |
| **POS Integration** | Toast API | Direct order submission to restaurant kitchen systems. Requires a Toast partnership agreement per restaurant. |
| **Global State** | Zustand | Lightweight global state for auth session and cart. No boilerplate, just a simple store with actions. |
| **Server State** | React Query (`@tanstack/react-query`) | Handles all data fetching, caching, and background refetching. Keeps the map data fresh as users pan. |
| **Deployment** | Vercel | Native Next.js deployment. Preview URLs on every branch. Free tier covers the launch phase. |

---

## 3. Directory Structure

```
studeals/
â”‚
â”œâ”€â”€ app/                          # Next.js App Router â€” every folder = a URL route
â”‚   â”œâ”€â”€ layout.tsx                # Root shell: providers, fonts, global metadata
â”‚   â”œâ”€â”€ page.tsx                  # Homepage / landing page (unauthenticated)
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ callback/route.ts     # Google OAuth redirect handler
â”‚   â”‚
â”‚   â”œâ”€â”€ onboarding/
â”‚   â”‚   â””â”€â”€ page.tsx              # .edu verification wizard (3 steps)
â”‚   â”‚
â”‚   â”œâ”€â”€ map/
â”‚   â”‚   â””â”€â”€ page.tsx              # Main map view â€” the core experience
â”‚   â”‚
â”‚   â”œâ”€â”€ places/
â”‚   â”‚   â””â”€â”€ [id]/page.tsx         # Individual place page (SSR for SEO)
â”‚   â”‚
â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â””â”€â”€ page.tsx              # Order history
â”‚   â”‚
â”‚   â”œâ”€â”€ profile/
â”‚   â”‚   â””â”€â”€ page.tsx              # User profile + rewards
â”‚   â”‚
â”‚   â””â”€â”€ api/                      # Backend API (runs server-side only)
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â”œâ”€â”€ edu-verify/route.ts    # Send .edu verification email
â”‚       â”‚   â””â”€â”€ edu-confirm/route.ts   # Confirm token â†’ mark user verified
â”‚       â”œâ”€â”€ places/
â”‚       â”‚   â”œâ”€â”€ route.ts               # GET all places (with filters)
â”‚       â”‚   â”œâ”€â”€ nearby/route.ts        # GET places within map bounds
â”‚       â”‚   â””â”€â”€ [id]/
â”‚       â”‚       â”œâ”€â”€ route.ts           # GET single place
â”‚       â”‚       â””â”€â”€ menu/route.ts      # GET menu items for a place
â”‚       â”œâ”€â”€ orders/
â”‚       â”‚   â”œâ”€â”€ route.ts               # POST create order + PaymentIntent
â”‚       â”‚   â”œâ”€â”€ [id]/confirm/route.ts  # POST confirm payment â†’ submit to Toast
â”‚       â”‚   â””â”€â”€ history/route.ts       # GET user order history
â”‚       â”œâ”€â”€ reviews/
â”‚       â”‚   â””â”€â”€ route.ts               # POST + GET reviews
â”‚       â”œâ”€â”€ users/
â”‚       â”‚   â””â”€â”€ me/route.ts            # GET + PUT current user profile
â”‚       â”œâ”€â”€ rewards/
â”‚       â”‚   â””â”€â”€ route.ts               # GET user rewards
â”‚       â””â”€â”€ webhooks/
â”‚           â””â”€â”€ stripe/route.ts        # Stripe payment webhook (server-to-server)
â”‚
â”œâ”€â”€ components/                   # Reusable UI components (no direct DB access)
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â””â”€â”€ AuthProvider.tsx       # Listens for auth changes, syncs to store
â”‚   â”œâ”€â”€ map/
â”‚   â”‚   â”œâ”€â”€ MapView.tsx            # Google Maps canvas + markers
â”‚   â”‚   â”œâ”€â”€ PlaceDrawer.tsx        # Slide-up panel when a marker is clicked
â”‚   â”‚   â””â”€â”€ FilterBar.tsx          # Category filter pills
â”‚   â”œâ”€â”€ order/
â”‚   â”‚   â”œâ”€â”€ Cart.tsx               # Cart sidebar
â”‚   â”‚   â””â”€â”€ CheckoutButton.tsx     # Stripe Elements payment trigger
â”‚   â””â”€â”€ place/
â”‚       â”œâ”€â”€ MenuGrid.tsx           # Menu items with student prices
â”‚       â””â”€â”€ ReviewList.tsx         # Reviews + write-a-review form
â”‚
â”œâ”€â”€ lib/                          # Service clients â€” third-party integrations
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts             # Browser Supabase client (client components)
â”‚   â”‚   â””â”€â”€ server.ts             # Server Supabase client (API routes, SSR)
â”‚   â”œâ”€â”€ stripe/
â”‚   â”‚   â””â”€â”€ client.ts             # Stripe SDK + helper functions
â”‚   â”œâ”€â”€ toast/
â”‚   â”‚   â””â”€â”€ client.ts             # Toast POS API client
â”‚   â”œâ”€â”€ email/
â”‚   â”‚   â””â”€â”€ resend.ts             # Resend email client + templates
â”‚   â”œâ”€â”€ rewards/
â”‚   â”‚   â””â”€â”€ rewardService.ts      # Business logic for reward milestones
â”‚   â””â”€â”€ maps/
â”‚       â””â”€â”€ utils.ts              # Google Maps helper functions
â”‚
â”œâ”€â”€ store/                        # Zustand global state stores
â”‚   â”œâ”€â”€ useAuthStore.ts           # Current user, session, edu_verified status
â”‚   â””â”€â”€ useCartStore.ts           # Cart items, quantities, computed totals
â”‚
â”œâ”€â”€ types/                        # TypeScript type definitions (shared everywhere)
â”‚   â”œâ”€â”€ user.ts
â”‚   â”œâ”€â”€ place.ts
â”‚   â”œâ”€â”€ order.ts
â”‚   â”œâ”€â”€ review.ts
â”‚   â””â”€â”€ reward.ts
â”‚
â”œâ”€â”€ supabase/                     # Database
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 001_initial_schema.sql  # All tables, indexes, RLS policies
â”‚       â””â”€â”€ seed.sql                # 10 sample Chicago spots for dev/testing
â”‚
â”œâ”€â”€ middleware.ts                 # Route protection â€” runs before every page load
â”œâ”€â”€ .env.local                    # API keys and secrets (NEVER commit this)
â”œâ”€â”€ next.config.ts                # Next.js build config
â””â”€â”€ package.json                  # Dependencies
```

---

## 4. The Data Layer â€” Database & Types

### Tables and Their Relationships

```
users
  â”‚  (one user has many)
  â”œâ”€â”€â–º orders       (every order belongs to a user)
  â”œâ”€â”€â–º reviews      (every review belongs to a user)
  â””â”€â”€â–º rewards      (every reward belongs to a user)

places
  â”‚  (one place has many)
  â”œâ”€â”€â–º menu_items   (every item belongs to a place)
  â”œâ”€â”€â–º orders       (every order is placed at a place)
  â””â”€â”€â–º reviews      (every review is about a place)
```

### Table Definitions

**`users`** â€” the core identity record. Created automatically when someone signs in with Google.

| Column | Type | Purpose |
|---|---|---|
| `id` | uuid PK | Primary key, matches Supabase Auth UID |
| `edu_email` | text unique | The verified .edu address |
| `personal_email` | text unique | For promotions and updates |
| `google_id` | text | Google OAuth ID |
| `display_name` | text | Their name from Google |
| `edu_verified` | boolean | False until they click the .edu verification link |
| `review_count` | integer | Increments on every submitted review |
| `rewards_balance` | numeric | Running total of earned reward value |
| `created_at` | timestamptz | Account creation timestamp |

**`places`** â€” every restaurant, cafÃ©, or drink spot on the map.

| Column | Type | Purpose |
|---|---|---|
| `id` | uuid PK | Primary key |
| `name` | text | Business name |
| `address` | text | Street address |
| `lat` / `lng` | numeric | Coordinates for map rendering |
| `category` | text[] | Array: `["drinks", "coffee"]` â€” supports multi-category |
| `discount_description` | text | Human-readable discount: "20% off all drinks" |
| `discount_percent` | numeric | Numeric discount for automated pricing |
| `pos_type` | text | `"toast"` or `null` â€” determines if ordering is available |
| `avg_rating` | numeric | Recomputed on every new review |
| `hours` | jsonb | `{ "mon": "7am-9pm", "tue": "7am-9pm", ... }` |
| `active` | boolean | Soft delete / unpublish without deleting the record |

**`menu_items`** â€” items that can be ordered from a place.

| Column | Type | Purpose |
|---|---|---|
| `place_id` | uuid FK | Which place this item belongs to |
| `price` | numeric | Regular price |
| `student_price` | numeric | Discounted student price â€” shown in green in the UI |
| `category` | text | Used for filtering within a menu (drinks, food, etc.) |
| `available` | boolean | Toggle items on/off (e.g., seasonal) |

**`orders`** â€” a completed or in-progress purchase.

| Column | Type | Purpose |
|---|---|---|
| `user_id` / `place_id` | uuid FK | Who ordered, and from where |
| `items` | jsonb | Snapshot of what was ordered at the time of purchase |
| `subtotal` | numeric | Before discount |
| `discount` | numeric | How much was saved |
| `total` | numeric | What was actually charged |
| `payment_intent_id` | text | Stripe PaymentIntent ID for reconciliation |
| `pos_order_id` | text | The ID returned by Toast after submission |
| `status` | text | `"pending"` â†’ `"paid"` â†’ `"sent"` â†’ (or `"failed"`) |

**`reviews`** â€” user reviews for places.

| Column | Type | Purpose |
|---|---|---|
| `user_id` / `place_id` | uuid FK | Who wrote it, and about what |
| `rating` | int | 1â€“5 stars |
| `body` | text | Review text |
| `verified_visit` | boolean | True if user placed an order at this place through the app |

**`rewards`** â€” $5 discount codes issued for review milestones.

| Column | Type | Purpose |
|---|---|---|
| `user_id` | uuid FK | Who earned it |
| `type` | text | `"review_milestone"` (extensible for future reward types) |
| `value` | numeric | `5.00` (dollars) |
| `stripe_coupon_id` | text | The actual Stripe coupon code to apply at checkout |
| `redeemed` | boolean | Flips to true when applied to an order |

### Row Level Security (RLS)

Supabase enforces RLS at the database level so users can **never** access each other's private data, even if the API has a bug.

```sql
-- Users can only read/write their own orders
CREATE POLICY "own orders only"
  ON orders FOR ALL
  USING (user_id = auth.uid());

-- Places are public (everyone can read)
CREATE POLICY "places are public"
  ON places FOR SELECT
  USING (true);

-- Reviews are public to read, but only the author can write
CREATE POLICY "reviews readable by all"
  ON reviews FOR SELECT USING (true);

CREATE POLICY "own reviews only for write"
  ON reviews FOR INSERT
  WITH CHECK (user_id = auth.uid());
```

### Types

Every TypeScript type is defined once in `types/` and imported everywhere. This means if you change a field in the database, you only update one file and TypeScript will flag every broken reference across the entire codebase.

```
types/user.ts    â†’ User, UserProfile, OnboardingState
types/place.ts   â†’ Place, PlaceCategory, PlaceMarker
types/order.ts   â†’ Order, OrderItem, OrderStatus, CartItem
types/review.ts  â†’ Review
types/reward.ts  â†’ Reward
```

---

## 5. The Auth System

Authentication has two layers: **Google OAuth** (who you are) and **.edu verification** (proving you're a student). These are separate concerns handled in different places.

### Flow Diagram

```
1. User clicks "Sign in with Google"
        â”‚
        â–¼
2. lib/supabase/client.ts calls signInWithOAuth({ provider: 'google' })
   â†’ Browser redirects to Google
        â”‚
        â–¼
3. Google redirects back to: /auth/callback?code=XXXXX
   â†’ app/auth/callback/route.ts
   â†’ Exchanges code for session via Supabase
   â†’ Creates user record in `users` table if new
        â”‚
        â”œâ”€â”€ New user (edu_verified = false) â†’ redirect /onboarding
        â””â”€â”€ Returning user (edu_verified = true) â†’ redirect /map
```

### The Onboarding Wizard (`app/onboarding/page.tsx`)

Three steps managed with a local `step` state variable:

**Step 1 â€” `edu_input`:**
User types their `.edu` email address. On submit, calls `POST /api/auth/edu-verify` which:
- Validates the email ends in `.edu`
- Generates a short-lived token (stored in Supabase with an expiry)
- Sends a verification email via Resend to that `.edu` address

**Step 2 â€” `edu_pending`:**
The UI shows "Check your inbox" and polls Supabase for `edu_verified = true`. When the user clicks the link in their `.edu` email, it hits `POST /api/auth/edu-confirm` which validates the token and sets `edu_verified = true`. The polling detects this change and advances to Step 3.

**Step 3 â€” `personal_email`:**
Collects their personal email (Gmail, etc.) for promotional updates and order confirmations. This is stored separately from the `.edu` address.

### Route Protection (`middleware.ts`)

Every request to a protected page runs through `middleware.ts` before the page renders:

```
Request arrives for /map
        â”‚
        â–¼
middleware.ts checks for Supabase session cookie
        â”‚
        â”œâ”€â”€ No session â†’ redirect to /
        â”œâ”€â”€ Session but edu_verified = false â†’ redirect to /onboarding
        â””â”€â”€ Session + edu_verified = true â†’ let through to /map
```

Protected routes: `/map`, `/orders`, `/profile`, and any `/places/[id]` ordering actions.

### Two Supabase Clients

There are two separate Supabase client files â€” this is not an accident, it is required by Next.js:

- **`lib/supabase/client.ts`** â€” used inside React components that run in the browser. Uses `NEXT_PUBLIC_` env vars. Reads the session from browser cookies.
- **`lib/supabase/server.ts`** â€” used in API routes and server-rendered pages. Uses the secret `SUPABASE_SERVICE_ROLE_KEY`. Required to get the authenticated user's identity on the server so you can trust who is making the request.

> **Rule:** Any API route that does something on behalf of a user (create order, submit review) must use the server client to verify `auth.uid()`. Never trust a user_id sent from the browser.

### Auth State in the App (`store/useAuthStore.ts` + `components/providers/AuthProvider.tsx`)

`AuthProvider` wraps the entire app in `layout.tsx`. On mount, it calls `supabase.auth.onAuthStateChange()` which fires whenever the session changes (login, logout, token refresh). It syncs the current user and session into the Zustand `useAuthStore`.

This means any component anywhere in the app can call `useAuthStore()` to read `{ user, session, isAuthenticated, eduVerified }` without prop drilling or re-fetching.

---

## 6. The Map System

The map is the core UI of StuDeals. It needs to be fast, filterable, and responsive to the user panning and zooming.

### Architecture

```
app/map/page.tsx
  â”‚
  â”œâ”€â”€ useQuery(['places', bounds, category])
  â”‚   â””â”€â”€ fetches from GET /api/places/nearby?north=&south=&east=&west=&category=
  â”‚
  â””â”€â”€ renders <MapView places={places} />
        â”‚
        â”œâ”€â”€ <FilterBar /> â€” category pills (Drinks, Coffee, Food...)
        â”‚     â””â”€â”€ onChange â†’ updates `category` state â†’ triggers re-fetch
        â”‚
        â”œâ”€â”€ Google Map canvas via @vis.gl/react-google-maps
        â”‚     â””â”€â”€ <PlaceMarker> for each place
        â”‚           â””â”€â”€ onClick â†’ sets `selectedPlace` state
        â”‚
        â””â”€â”€ <PlaceDrawer place={selectedPlace} />
              â”œâ”€â”€ Shows: name, discount badge, rating, hours, category
              â”œâ”€â”€ "Get Directions" â†’ lib/maps/utils.ts â†’ getDirectionsUrl(lat, lng)
              â”‚     â†’ opens https://maps.google.com/?daddr=LAT,LNG in new tab
              â”‚     â†’ on mobile, deep-links into Google Maps app
              â””â”€â”€ "View Menu & Order" â†’ navigate to /places/[id]
```

### Bounds-Based Querying (`app/api/places/nearby/route.ts`)

Rather than loading all Chicago places on every render, the map only loads what's visible. When the user pans or zooms, `MapView` fires `onBoundsChange` with the current NE/SW coordinates. The parent `map/page.tsx` updates its `bounds` state, which invalidates the React Query cache and fetches only the places within that viewport.

```
User pans map east
    â”‚
    â–¼
MapView fires onBoundsChange({ north, south, east, west })
    â”‚
    â–¼
map/page.tsx updates bounds state
    â”‚
    â–¼
React Query detects bounds changed â†’ refetches
    â”‚
    â–¼
GET /api/places/nearby?north=42.1&south=41.7&east=-87.5&west=-87.9
    â”‚
    â–¼
Supabase query: WHERE lat BETWEEN south AND north AND lng BETWEEN west AND east
    â”‚
    â–¼
New markers appear for the newly visible area
```

### Direction Deep Links (`lib/maps/utils.ts`)

```typescript
// getDirectionsUrl builds a URL that:
// - On desktop: opens Google Maps website
// - On iOS: deep-links into the Google Maps app
// - On Android: deep-links into the Google Maps app
export function getDirectionsUrl(lat: number, lng: number, name: string): string {
  return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&destination_place_id=${name}`
}
```

---

## 7. The Ordering System

The ordering flow is the most complex part of the codebase because it involves three external systems: your database, Stripe (payments), and Toast (POS delivery). The critical design principle is: **never trust the client for prices or payment confirmation.**

### Full Order Flow

```
1. User browses menu on /places/[id]
   â””â”€â”€ MenuGrid.tsx shows items with student prices
   â””â”€â”€ "Add to Cart" â†’ updates useCartStore (Zustand)

2. Cart.tsx reads useCartStore
   â””â”€â”€ Shows items, discount calculation, total
   â””â”€â”€ CheckoutButton triggers checkout

3. CheckoutButton calls POST /api/orders
   Server-side:
   â”œâ”€â”€ Re-fetches all item prices from DB (never trust client prices)
   â”œâ”€â”€ Re-calculates discount (never trust client totals)
   â”œâ”€â”€ Creates order record (status: "pending")
   â””â”€â”€ Creates Stripe PaymentIntent for the real total
   Returns: { orderId, clientSecret }

4. Client uses clientSecret to render Stripe Elements
   â””â”€â”€ User enters card details (handled entirely by Stripe, never touches our server)
   â””â”€â”€ Stripe processes payment

5. Stripe fires webhook to POST /api/webhooks/stripe
   Server-side (signature verified first):
   â”œâ”€â”€ Finds order by payment_intent_id
   â”œâ”€â”€ Updates order status to "paid"
   â”œâ”€â”€ Calls lib/toast/client.ts â†’ submitOrderToToast()
   â”‚   â””â”€â”€ Sends order to restaurant's Toast POS system
   â””â”€â”€ Updates order status to "sent"

6. User sees order confirmation with order number
   â””â”€â”€ "Get Directions" link to pick up order
```

### Why the Webhook Pattern Matters

A common mistake would be to have the client call a "confirm payment" endpoint after Stripe returns success on the frontend. **This is insecure.** A malicious user could call that endpoint without actually paying.

Instead, Stripe calls `POST /api/webhooks/stripe` directly from Stripe's servers, and that endpoint verifies the request signature using your `STRIPE_WEBHOOK_SECRET` before doing anything. This is the only trustworthy signal that payment actually succeeded.

### Toast POS Integration (`lib/toast/client.ts`)

When an order is confirmed, `submitOrderToToast()` maps the StuDeals order format to Toast's schema:

```
StuDeals Order                    Toast Order
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
items[].name         â†’            selections[].name
items[].quantity     â†’            selections[].quantity
items[].student_price â†’           selections[].price
place.pos_restaurant_id â†’         restaurantGuid
order.id             â†’            externalId (for tracking)
```

Toast returns a `posOrderId` which gets saved back to the order record so you can cross-reference if a restaurant ever says they didn't receive an order.

> **Note:** Each restaurant must individually connect to StuDeals via the Toast partner program. When you onboard a new restaurant, they give you their `restaurantGuid` which gets stored in the `places` table as part of their profile.

---

## 8. The Rewards System

The rewards system is triggered automatically after every successful review submission.

### Flow

```
User submits a review
        â”‚
        â–¼
POST /api/reviews
  â”œâ”€â”€ Insert review record
  â”œâ”€â”€ INCREMENT users.review_count
  â”œâ”€â”€ Recalculate places.avg_rating
  â””â”€â”€ Call lib/rewards/rewardService.ts â†’ checkAndIssueReward(userId)
              â”‚
              â–¼
        Is review_count divisible by 5?  (e.g. 5, 10, 15, 20...)
              â”‚
        YES   â”‚   NO
              â”‚   â””â”€â”€ Do nothing
              â–¼
        Create Stripe coupon ($5 off, single use)
              â”‚
              â–¼
        Insert reward record in DB
        { user_id, type: 'review_milestone', value: 5, stripe_coupon_id, redeemed: false }
              â”‚
              â–¼
        Send email via Resend: "You earned a $5 reward!"
        Email includes the coupon code
              â”‚
              â–¼
        At checkout: user applies coupon
        Stripe deducts $5 from the total
        Reward marked as redeemed: true
```

### Why Stripe Coupons?

Using Stripe coupons (rather than a custom discount logic) means: Stripe enforces the single-use rule, Stripe handles the deduction, and the reward is auditable in your Stripe dashboard alongside all payments. You don't need to write "was this coupon already used?" logic â€” Stripe handles it.

---

## 9. Global State â€” Zustand Stores

Only two things live in global state: who the user is, and what's in their cart. Everything else is fetched from the server via React Query.

### `store/useAuthStore.ts`

```typescript
interface AuthStore {
  user: User | null
  session: Session | null
  isAuthenticated: boolean
  eduVerified: boolean

  // Actions
  setUser: (user: User) => void
  setSession: (session: Session) => void
  clearAuth: () => void
}
```

**Who sets it:** `AuthProvider.tsx` on mount and on every `onAuthStateChange` event.

**Who reads it:** Anywhere in the app that needs to know if the user is logged in. The middleware also reads the session from cookies (separately from this store â€” Zustand is browser-only).

### `store/useCartStore.ts`

```typescript
interface CartStore {
  items: CartItem[]
  placeId: string | null      // Cart is locked to one restaurant at a time

  // Actions
  addItem: (item: CartItem) => void
  removeItem: (itemId: string) => void
  updateQuantity: (itemId: string, qty: number) => void
  clearCart: () => void

  // Computed selectors
  cartTotal: () => number            // Sum of regular prices
  cartTotalWithDiscount: () => number // Sum of student prices
  totalSavings: () => number         // Difference
  itemCount: () => number
}
```

**Important:** The cart is locked to one restaurant at a time. If a user has items from CafÃ© A and tries to add something from CafÃ© B, the store rejects it and shows a prompt: "Your cart has items from [CafÃ© A]. Clear cart and start new order?"

**Why Zustand over Context?** Zustand doesn't re-render the entire tree on every state change the way a naive Context implementation would. Only components that subscribe to the specific slice of state they need will re-render.

---

## 10. API Routes â€” Every Endpoint Explained

All API routes live in `app/api/`. They run server-side only and have access to secret environment variables. Components never call the database directly â€” they always go through these routes.

### Auth Routes

| Method | Path | What It Does |
|---|---|---|
| `POST` | `/api/auth/edu-verify` | Validates `.edu` email, generates token, sends verification email via Resend. Returns `{ ok: true }`. |
| `POST` | `/api/auth/edu-confirm` | Receives token from email link. Validates it hasn't expired. Sets `edu_verified = true`. Redirects to next onboarding step. |

### Place Routes

| Method | Path | What It Does |
|---|---|---|
| `GET` | `/api/places` | Returns all active places. Accepts `?category=drinks` filter. Used for non-map list views. |
| `GET` | `/api/places/nearby` | Returns places within a lat/lng bounding box. Accepts `?north=&south=&east=&west=&category=`. The map calls this on every pan/zoom. |
| `GET` | `/api/places/[id]` | Single place with full details including hours and discount info. |
| `GET` | `/api/places/[id]/menu` | All menu items for a place. Each item includes `price` and `student_price`. |

### Order Routes

| Method | Path | What It Does |
|---|---|---|
| `POST` | `/api/orders` | Creates order. Re-validates all prices server-side. Creates Stripe PaymentIntent. Returns `{ orderId, clientSecret }`. |
| `POST` | `/api/orders/[id]/confirm` | Called by Stripe webhook only. Updates order to `paid`, submits to Toast POS, updates to `sent`. |
| `GET` | `/api/orders/history` | Returns the authenticated user's full order history, newest first. |

### Review Routes

| Method | Path | What It Does |
|---|---|---|
| `POST` | `/api/reviews` | Inserts review. Increments `review_count`. Recalculates `avg_rating` on place. Triggers reward check. |
| `GET` | `/api/reviews/[placeId]` | Returns all reviews for a specific place, ordered by recency. |

### User Routes

| Method | Path | What It Does |
|---|---|---|
| `GET` | `/api/users/me` | Returns the authenticated user's profile: name, edu_verified status, review_count, rewards_balance. |
| `PUT` | `/api/users/me` | Updates `display_name` or `personal_email`. |

### Reward Routes

| Method | Path | What It Does |
|---|---|---|
| `GET` | `/api/rewards` | Returns all rewards for the current user with redemption status. |

### Webhook Routes

| Method | Path | What It Does |
|---|---|---|
| `POST` | `/api/webhooks/stripe` | Receives `payment_intent.succeeded` events from Stripe. **Always verifies signature first.** Triggers order confirmation and Toast submission. This must be excluded from CSRF protection in `next.config.ts`. |

---

## 11. Third-Party Integrations

### Supabase (`lib/supabase/`)

Two clients, same database, different contexts:

```typescript
// client.ts â€” browser context (React components)
import { createBrowserClient } from '@supabase/ssr'
export const supabase = createBrowserClient(url, anonKey)

// server.ts â€” server context (API routes, middleware)
import { createServerClient } from '@supabase/ssr'
export function createSupabaseServer(cookieStore) {
  return createServerClient(url, serviceRoleKey, { cookies: cookieStore })
}
```

The `anonKey` is safe to expose publicly â€” Supabase RLS policies enforce what anonymous keys can and can't do. The `serviceRoleKey` bypasses RLS and must never be exposed to the browser.

### Stripe (`lib/stripe/client.ts`)

```typescript
import Stripe from 'stripe'
export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY)

// Create a payment intent for an order total
export async function createPaymentIntent(amount: number, metadata: object) {
  return stripe.paymentIntents.create({
    amount: Math.round(amount * 100), // Stripe uses cents
    currency: 'usd',
    metadata
  })
}

// Create a $5 coupon for the rewards system
export async function createCoupon(value: number) {
  return stripe.coupons.create({
    amount_off: value * 100,
    currency: 'usd',
    max_redemptions: 1, // Single use
    duration: 'once'
  })
}
```

### Toast POS (`lib/toast/client.ts`)

Toast requires a formal partnership agreement to get API access. Each restaurant that joins StuDeals must be on Toast and their `restaurantGuid` must be stored in the `places` table.

```typescript
export async function submitOrderToToast(restaurantGuid: string, order: Order) {
  return fetch(`https://ws-api.toasttab.com/orders/v2/orders`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.TOAST_API_KEY}`,
      'Toast-Restaurant-External-ID': restaurantGuid
    },
    body: JSON.stringify(mapToToastSchema(order))
  })
}
```

### Resend Email (`lib/email/resend.ts`)

Three email types are sent:

1. **`.edu` verification** â€” sent during onboarding. Contains a one-time token link.
2. **Order confirmation** â€” sent after `payment_intent.succeeded` webhook fires.
3. **Reward earned** â€” sent when a user hits a review milestone.

```typescript
import { Resend } from 'resend'
const resend = new Resend(process.env.RESEND_API_KEY)

export async function sendEduVerification(to: string, token: string) {
  const verifyUrl = `${process.env.NEXT_PUBLIC_URL}/api/auth/edu-confirm?token=${token}`
  return resend.emails.send({
    from: 'verify@studeals.com',
    to,
    subject: 'Verify your student email',
    html: `<a href="${verifyUrl}">Click to verify</a>`
  })
}
```

---

## 12. How Files Talk to Each Other â€” Dependency Map

Reading this left-to-right: the left side depends on the right side.

```
PAGES & COMPONENTS                API ROUTES               SERVICES & DB
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app/page.tsx
  â””â”€â”€ (no API call, static)

app/auth/callback/route.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º lib/supabase/server.ts

app/onboarding/page.tsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º /api/auth/edu-verify â”€â”€â–º lib/email/resend.ts
                                   /api/auth/edu-confirm â”€â”€â–º lib/supabase/server.ts

app/map/page.tsx
  â””â”€â”€ components/map/MapView â”€â”€â”€â”€â”€â–º /api/places/nearby â”€â”€â”€â–º lib/supabase/server.ts
  â””â”€â”€ components/map/FilterBar      /api/places          â”€â”€â–º lib/supabase/server.ts
  â””â”€â”€ components/map/PlaceDrawer
        â””â”€â”€ lib/maps/utils.ts (directions URL, no API call)

app/places/[id]/page.tsx â”€â”€â”€â”€â”€â”€â”€â”€â–º /api/places/[id] â”€â”€â”€â”€â”€â”€â–º lib/supabase/server.ts
  â””â”€â”€ components/place/MenuGrid    /api/places/[id]/menu â”€â”€â–º lib/supabase/server.ts
        â””â”€â”€ store/useCartStore

  â””â”€â”€ components/place/ReviewList â–º /api/reviews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º lib/supabase/server.ts
                                                           â””â–º lib/rewards/rewardService.ts
                                                                 â””â”€â”€ lib/stripe/client.ts
                                                                 â””â”€â”€ lib/email/resend.ts

  â””â”€â”€ components/order/Cart
        â””â”€â”€ store/useCartStore
        â””â”€â”€ components/order/CheckoutButton
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º /api/orders â”€â”€â”€â–º lib/supabase/server.ts
                                                           â””â–º lib/stripe/client.ts

app/api/webhooks/stripe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ lib/stripe/client.ts
  (called by Stripe, not by our app)                      â””â–º lib/toast/client.ts
                                                          â””â–º lib/supabase/server.ts

app/orders/page.tsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º /api/orders/history â”€â”€â”€â–º lib/supabase/server.ts

app/profile/page.tsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º /api/users/me â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º lib/supabase/server.ts
                                   /api/rewards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º lib/supabase/server.ts

components/providers/AuthProvider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ lib/supabase/client.ts
  â””â”€â”€ store/useAuthStore                                  â””â–º store/useAuthStore

middleware.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ lib/supabase/server.ts
```

**The pattern to notice:**
- Pages only import components and React Query hooks
- Components only import stores and make fetch() calls to API routes
- API routes import from `lib/` services
- `lib/` services import from third-party SDKs
- No component ever imports from `lib/` directly (except `lib/maps/utils.ts` which has no secrets)
- No API route ever imports from `components/`

This strict layering means you can change how Stripe works without touching any component, and you can redesign the Map component without touching any API route.

---

## 13. Environment Variables

Create a `.env.local` file in the project root. **This file must never be committed to Git.** Add all of these to Vercel's environment variables dashboard for production.

```env
# Supabase â€” get from your Supabase project dashboard
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...          # Safe to expose publicly
SUPABASE_SERVICE_ROLE_KEY=eyJ...              # SECRET â€” server only, never expose

# Google Maps â€” get from Google Cloud Console
# Enable: Maps JavaScript API, Places API, Directions API
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIza...       # Restrict to your domain in GCP

# Stripe â€” get from Stripe dashboard
STRIPE_SECRET_KEY=sk_live_...                 # SECRET â€” server only
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_... # Safe to expose publicly
STRIPE_WEBHOOK_SECRET=whsec_...               # SECRET â€” from Stripe webhook settings

# Resend â€” get from resend.com
RESEND_API_KEY=re_...                         # SECRET â€” server only

# Toast â€” get from Toast partner program
TOAST_API_KEY=...                             # SECRET â€” server only

# App URL (used for building verification links)
NEXT_PUBLIC_URL=https://studeals.com          # Use http://localhost:3000 for dev
```

**Prefix rules:**
- `NEXT_PUBLIC_` variables are bundled into the client-side JavaScript and visible to anyone who opens DevTools. Only use this prefix for things that are safe to be public (Supabase anon key, Google Maps key, Stripe publishable key).
- Variables without `NEXT_PUBLIC_` are only available server-side. Use these for all secret keys.

---

## 14. Build Phases

### Phase 1 â€” Foundation (Build This First)

Get a working app deployed before adding complexity.

- [ ] `npx create-next-app@latest studeals --typescript --tailwind --app`
- [ ] Create Supabase project, run `001_initial_schema.sql` migration
- [ ] Configure Google OAuth in Supabase dashboard
- [ ] Build homepage (`app/page.tsx`) with Google sign-in
- [ ] Build `app/auth/callback/route.ts`
- [ ] Build onboarding wizard with `.edu` verification
- [ ] Build `middleware.ts` for route protection
- [ ] Build map page with Google Maps + hardcoded place data (skip the DB for now)
- [ ] Add real places from DB with `seed.sql`
- [ ] Add category filter
- [ ] Build `PlaceDrawer` with directions link
- [ ] Deploy to Vercel

**Goal:** A real deployed URL where students can sign in, verify their .edu, and see Chicago discount spots on a map.

### Phase 2 â€” Commerce

- [ ] Build `/places/[id]` page with `MenuGrid`
- [ ] Build `useCartStore`
- [ ] Integrate Stripe â€” `CheckoutButton`, `createPaymentIntent`
- [ ] Build order creation API route
- [ ] Set up Stripe webhook endpoint
- [ ] Apply for Toast API partner access
- [ ] Build `lib/toast/client.ts` and order confirmation flow
- [ ] Build order history page
- [ ] Build review system + `rewardService`

**Goal:** End-to-end order flow working for at least one Toast-connected restaurant.

### Phase 3 â€” Intelligence

- [ ] Behavior tracking (what categories users browse, what they order)
- [ ] Personalized place recommendations on the map
- [ ] Seasonal promotions system (midterms coffee deals)
- [ ] Admin dashboard for managing places and promotions
- [ ] Business onboarding flow (self-serve for small businesses)
- [ ] React Native migration (reuses all `lib/`, `store/`, `types/`, and API routes)
- [ ] App Store submission

---

## 15. Getting Started

### Prerequisites

- Node.js 18+
- A [Supabase](https://supabase.com) account (free)
- A [Google Cloud](https://console.cloud.google.com) project with Maps JavaScript API enabled
- A [Stripe](https://stripe.com) account (test mode to start)
- A [Resend](https://resend.com) account (free tier)

### Setup

```bash
# 1. Clone the repo
git clone https://github.com/your-username/studeals.git
cd studeals

# 2. Install dependencies
npm install

# 3. Copy environment variables
cp .env.example .env.local
# Fill in all values in .env.local

# 4. Set up the database
# Go to your Supabase dashboard â†’ SQL Editor
# Paste and run: supabase/migrations/001_initial_schema.sql
# Then run: supabase/seed.sql (adds sample Chicago data)

# 5. Run the development server
npm run dev

# Open http://localhost:3000
```

### Stripe Webhook (Local Development)

Stripe can't call your localhost directly. Use the Stripe CLI to forward webhooks:

```bash
# Install Stripe CLI, then:
stripe listen --forward-to localhost:3000/api/webhooks/stripe

# Copy the webhook signing secret it outputs into .env.local as STRIPE_WEBHOOK_SECRET
```

---

*Built with Next.js Â· Supabase Â· Google Maps Â· Stripe Â· Toast Â· Resend*