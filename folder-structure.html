<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StuDeals â€” Directory Structure</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #141414;
    --surface2: #1c1c1c;
    --border: #252525;
    --accent: #4fffb0;
    --accent2: #7c6aff;
    --accent3: #ff6a6a;
    --accent4: #ffc86a;
    --accent5: #6ab8ff;
    --text: #e8e8f0;
    --muted: #555566;
    --muted2: #888899;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.6;
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(79,255,176,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(79,255,176,0.025) 1px, transparent 1px);
    background-size: 32px 32px;
    pointer-events: none;
    z-index: 0;
  }

  .layout {
    display: grid;
    grid-template-columns: 420px 1fr;
    min-height: 100vh;
    position: relative;
    z-index: 1;
  }

  /* LEFT PANEL â€” tree */
  .tree-panel {
    background: var(--surface);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    position: sticky;
    top: 0;
    height: 100vh;
  }

  .tree-header {
    padding: 28px 24px 20px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 10;
  }

  .tree-header .tag {
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 6px;
  }

  .tree-header h2 {
    font-family: var(--font-head);
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
  }

  .tree-header h2 span { color: var(--accent); }

  .tree-body {
    padding: 16px 0 32px;
  }

  /* Tree nodes */
  .tree-node {
    user-select: none;
  }

  .tree-node-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 16px;
    cursor: pointer;
    transition: background 0.1s;
    white-space: nowrap;
    border-left: 2px solid transparent;
  }

  .tree-node-row:hover {
    background: var(--surface2);
  }

  .tree-node-row.active {
    background: rgba(79,255,176,0.06);
    border-left-color: var(--accent);
  }

  .tree-node-row.active .node-name {
    color: var(--accent);
  }

  .indent { display: inline-block; }

  .toggle-icon {
    font-size: 9px;
    color: var(--muted);
    min-width: 12px;
    text-align: center;
    transition: transform 0.15s;
  }

  .toggle-icon.open { transform: rotate(90deg); }

  .node-icon {
    font-size: 13px;
    min-width: 18px;
    text-align: center;
  }

  .node-name {
    font-size: 12px;
    font-weight: 400;
    color: var(--text);
    flex: 1;
  }

  .node-name.folder {
    font-weight: 600;
    color: var(--accent4);
  }

  .node-name.root {
    font-family: var(--font-head);
    font-size: 14px;
    font-weight: 700;
    color: var(--accent);
  }

  .node-badge {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 2px;
    letter-spacing: 0.05em;
  }

  .badge-api { background: rgba(124,106,255,0.2); color: var(--accent2); }
  .badge-ui { background: rgba(79,255,176,0.15); color: var(--accent); }
  .badge-db { background: rgba(255,200,106,0.15); color: var(--accent4); }
  .badge-svc { background: rgba(255,106,106,0.15); color: var(--accent3); }
  .badge-cfg { background: rgba(106,184,255,0.15); color: var(--accent5); }
  .badge-type { background: rgba(136,136,153,0.2); color: var(--muted2); }

  .tree-children { display: none; }
  .tree-children.open { display: block; }

  .tree-divider {
    height: 1px;
    background: var(--border);
    margin: 8px 16px;
  }

  /* RIGHT PANEL â€” detail */
  .detail-panel {
    padding: 40px 48px;
    overflow-y: auto;
  }

  .detail-empty {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    text-align: center;
    gap: 12px;
  }

  .detail-empty .big { font-size: 48px; }
  .detail-empty p { font-size: 12px; color: var(--muted); }

  .detail-content { display: none; }
  .detail-content.active { display: block; }

  .detail-path {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-bottom: 6px;
  }

  .detail-filename {
    font-family: var(--font-head);
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    margin-bottom: 6px;
  }

  .detail-role {
    font-size: 11px;
    color: var(--muted2);
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .detail-section {
    margin-bottom: 28px;
  }

  .detail-section-title {
    font-size: 9px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .detail-desc {
    font-size: 12px;
    color: var(--muted2);
    line-height: 1.8;
  }

  .code-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent2);
    padding: 16px 20px;
    font-size: 11px;
    line-height: 1.9;
    overflow-x: auto;
    white-space: pre;
    color: var(--text);
  }

  .code-block .comment { color: var(--muted); }
  .code-block .keyword { color: var(--accent2); }
  .code-block .string { color: var(--accent); }
  .code-block .fn { color: var(--accent4); }
  .code-block .type { color: var(--accent3); }

  .connects-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .connect-tag {
    font-size: 11px;
    padding: 4px 12px;
    border: 1px solid var(--border);
    color: var(--muted2);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .connect-tag::before { content: 'â†’'; color: var(--muted); font-size: 10px; }

  .exports-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .export-item {
    display: flex;
    align-items: baseline;
    gap: 12px;
    padding: 8px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
  }

  .export-name {
    font-size: 12px;
    color: var(--accent4);
    min-width: 180px;
  }

  .export-desc {
    font-size: 11px;
    color: var(--muted2);
  }

  /* Legend */
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    background: var(--surface);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--muted2);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  @media (max-width: 900px) {
    .layout { grid-template-columns: 1fr; }
    .tree-panel { height: auto; position: relative; }
    .detail-panel { padding: 24px 20px; }
  }
</style>
</head>
<body>

<div class="layout">
  <!-- LEFT: FILE TREE -->
  <div class="tree-panel">
    <div class="tree-header">
      <div class="tag">// Project Structure</div>
      <h2>Stude<span>als</span>/</h2>
    </div>
    <div class="tree-body" id="tree"></div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent2)"></div>API Route</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div>UI Component</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent4)"></div>DB / Schema</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent3)"></div>Service</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--accent5)"></div>Config</div>
    </div>
  </div>

  <!-- RIGHT: DETAIL -->
  <div class="detail-panel" id="detail">
    <div class="detail-empty" id="empty-state">
      <div class="big">ğŸ“‚</div>
      <p>Click any file in the tree<br>to see its role, exports, and connections</p>
    </div>
  </div>
</div>

<script>
const tree = [
  { id:'root', name:'studeals/', icon:'ğŸ—‚ï¸', type:'root', children:[

    { id:'app', name:'app/', icon:'ğŸ“', type:'folder', badge:'', children:[

      { id:'layout', name:'layout.tsx', icon:'âš›ï¸', badge:'ui',
        path:'app/layout.tsx',
        role:'Root layout â€” wraps every page. Loads fonts, global CSS, auth provider, and toast notifications.',
        desc:'This is the outermost shell of the entire application. Every page renders inside this. It sets up the QueryClientProvider for React Query, the Supabase auth session listener, and the global Zustand store hydration.',
        code:`<span class="keyword">export default function</span> <span class="fn">RootLayout</span>({ children }) {
  <span class="comment">// Wrap with: QueryClient, AuthProvider,</span>
  <span class="comment">// Toaster, global metadata</span>
  <span class="keyword">return</span> (
    &lt;html&gt;
      &lt;AuthProvider&gt;
        &lt;QueryClientProvider&gt;
          {children}
          &lt;Toaster /&gt;
        &lt;/QueryClientProvider&gt;
      &lt;/AuthProvider&gt;
    &lt;/html&gt;
  )
}`,
        exports:['RootLayout (default)'],
        connects:['lib/supabase/client.ts','components/providers/AuthProvider','store/useAuthStore']
      },

      { id:'page-home', name:'page.tsx', icon:'ğŸ ', badge:'ui',
        path:'app/page.tsx',
        role:'Homepage â€” marketing landing page with map preview and sign-up CTA.',
        desc:'The first thing a non-logged-in user sees. Shows a blurred/teaser map of Chicago, a hero headline, and a "Sign in with Google" button. If the user is already logged in it redirects to /map.',
        code:`<span class="comment">// Redirect if already authed</span>
<span class="keyword">if</span> (session) redirect(<span class="string">'/map'</span>)

<span class="comment">// Otherwise show hero + CTA</span>
<span class="keyword">return</span> &lt;HeroSection /&gt;`,
        exports:['HomePage (default)'],
        connects:['app/map/page.tsx','components/landing/HeroSection','lib/supabase/server.ts']
      },

      { id:'app-auth', name:'auth/', icon:'ğŸ“', type:'folder', children:[
        { id:'auth-callback', name:'callback/route.ts', icon:'ğŸ”', badge:'api',
          path:'app/auth/callback/route.ts',
          role:'OAuth callback handler â€” Google redirects here after login.',
          desc:'After a successful Google OAuth flow, Supabase redirects to this route. It exchanges the code for a session, sets the cookie, then redirects the user to /onboarding if new or /map if returning.',
          code:`<span class="keyword">export async function</span> <span class="fn">GET</span>(req) {
  <span class="keyword">const</span> code = url.searchParams.get(<span class="string">'code'</span>)
  <span class="keyword">await</span> supabase.auth.exchangeCodeForSession(code)
  <span class="comment">// Check if edu_verified â†’ route accordingly</span>
  redirect(isNew ? <span class="string">'/onboarding'</span> : <span class="string">'/map'</span>)
}`,
          exports:['GET'],
          connects:['lib/supabase/server.ts','app/onboarding/page.tsx','app/map/page.tsx']
        },
      ]},

      { id:'app-onboarding', name:'onboarding/', icon:'ğŸ“', type:'folder', children:[
        { id:'onboarding-page', name:'page.tsx', icon:'ğŸ“', badge:'ui',
          path:'app/onboarding/page.tsx',
          role:'Multi-step onboarding â€” .edu verification + personal email collection.',
          desc:'3-step wizard: Step 1 asks for .edu email and sends verification. Step 2 waits for confirmation (polls or uses realtime). Step 3 asks for personal email for promos. Cannot be skipped â€” protected by middleware.',
          code:`<span class="comment">// Steps: edu_input â†’ edu_pending â†’ personal_email</span>
<span class="keyword">const</span> [step, setStep] = useState&lt;<span class="type">OnboardStep</span>&gt;(<span class="string">'edu_input'</span>)

<span class="fn">sendEduVerification</span>(eduEmail)  <span class="comment">// â†’ /api/auth/edu-verify</span>
<span class="fn">pollVerificationStatus</span>()       <span class="comment">// watch edu_verified field</span>`,
          exports:['OnboardingPage (default)'],
          connects:['app/api/auth/edu-verify/route.ts','app/api/auth/edu-confirm/route.ts','store/useAuthStore']
        },
      ]},

      { id:'app-map', name:'map/', icon:'ğŸ“', type:'folder', children:[
        { id:'map-page', name:'page.tsx', icon:'ğŸ—ºï¸', badge:'ui',
          path:'app/map/page.tsx',
          role:'Main map page â€” the core experience. Protected route.',
          desc:'The heart of the app. Renders the MapView component (Google Maps), the sidebar filter panel, and the place detail drawer. Fetches places from /api/places/nearby based on current map bounds. State is managed via React Query.',
          code:`<span class="comment">// Fetch places within visible map bounds</span>
<span class="keyword">const</span> { data: places } = useQuery({
  queryKey: [<span class="string">'places'</span>, bounds, category],
  queryFn: () => <span class="fn">fetchNearbyPlaces</span>(bounds, category)
})
<span class="keyword">return</span> &lt;MapView places={places} /&gt;`,
          exports:['MapPage (default)'],
          connects:['components/map/MapView','components/map/PlaceDrawer','components/map/FilterBar','app/api/places/nearby/route.ts']
        },
      ]},

      { id:'app-place', name:'places/', icon:'ğŸ“', type:'folder', children:[
        { id:'place-detail', name:'[id]/page.tsx', icon:'ğŸª', badge:'ui',
          path:'app/places/[id]/page.tsx',
          role:'Individual place page â€” SSR for SEO. Shows menu, reviews, order button.',
          desc:'Server-side rendered so Google can index each business. Shows full place info, the menu with student prices highlighted, all reviews, average rating, and an order button (if Toast-connected).',
          exports:['PlacePage (default)'],
          connects:['app/api/places/route.ts','components/place/MenuGrid','components/place/ReviewList','components/order/OrderButton'],
          desc2:'Also handles the "Get Directions" button which constructs a Google Maps deep link using the place lat/lng.'
        },
      ]},

      { id:'app-order', name:'orders/', icon:'ğŸ“', type:'folder', children:[
        { id:'order-history', name:'page.tsx', icon:'ğŸ§¾', badge:'ui',
          path:'app/orders/page.tsx',
          role:'Order history â€” list of all past orders with status.',
          exports:['OrdersPage (default)'],
          connects:['app/api/orders/history/route.ts','components/order/OrderCard'],
          desc:'Shows all past orders with status badges (pending/paid/sent to kitchen). Each order is expandable to show items ordered and discount applied.'
        },
      ]},

      { id:'app-profile', name:'profile/', icon:'ğŸ“', type:'folder', children:[
        { id:'profile-page', name:'page.tsx', icon:'ğŸ‘¤', badge:'ui',
          path:'app/profile/page.tsx',
          role:'User profile â€” rewards balance, review count, settings.',
          exports:['ProfilePage (default)'],
          connects:['app/api/users/me/route.ts','app/api/rewards/route.ts','components/profile/RewardsBadge'],
          desc:'Shows the user\'s name, .edu verification status (green badge), review count progress bar toward next $5 reward, and reward history. Also lets user update their personal email.'
        },
      ]},

      { id:'app-api', name:'api/', icon:'ğŸ“', type:'folder', badge:'', children:[

        { id:'api-auth', name:'auth/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-edu-verify', name:'edu-verify/route.ts', icon:'ğŸ“¨', badge:'api',
            path:'app/api/auth/edu-verify/route.ts',
            role:'POST â€” sends .edu verification email via Resend.',
            desc:'Validates the email ends in .edu. Generates a short-lived token (stored in Supabase), then uses Resend to send a verification link to that .edu address. Returns 200 on success.',
            code:`<span class="keyword">export async function</span> <span class="fn">POST</span>(req) {
  <span class="keyword">const</span> { eduEmail } = <span class="keyword">await</span> req.json()
  <span class="comment">// 1. Validate .edu suffix</span>
  <span class="comment">// 2. Generate token â†’ store in DB</span>
  <span class="comment">// 3. Send email via Resend</span>
  <span class="keyword">return</span> Response.json({ ok: <span class="keyword">true</span> })
}`,
            exports:['POST'],
            connects:['lib/email/resend.ts','lib/supabase/server.ts']
          },
          { id:'api-edu-confirm', name:'edu-confirm/route.ts', icon:'âœ…', badge:'api',
            path:'app/api/auth/edu-confirm/route.ts',
            role:'POST â€” confirms .edu token, marks user as verified.',
            desc:'Called when the user clicks the link in their .edu email. Validates the token hasn\'t expired, sets edu_verified = true on the user record in Supabase, and redirects to Step 3 of onboarding.',
            exports:['POST'],
            connects:['lib/supabase/server.ts','app/onboarding/page.tsx']
          },
        ]},

        { id:'api-places', name:'places/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-places-list', name:'route.ts', icon:'ğŸ“', badge:'api',
            path:'app/api/places/route.ts',
            role:'GET â€” returns all active places with optional category filter.',
            exports:['GET'],
            connects:['lib/supabase/server.ts','types/place.ts'],
            desc:'Queries the places table. Accepts ?category=drinks query param. Returns id, name, lat, lng, discount info, avg_rating, pos_type.'
          },
          { id:'api-places-nearby', name:'nearby/route.ts', icon:'ğŸ“¡', badge:'api',
            path:'app/api/places/nearby/route.ts',
            role:'GET â€” returns places within a lat/lng bounding box (for map view).',
            desc:'Takes ?north=&south=&east=&west= from map bounds. Uses Supabase PostGIS or a simple coordinate range query to return only the places visible in the current map viewport. Efficient â€” doesn\'t load all places at once.',
            exports:['GET'],
            connects:['lib/supabase/server.ts','types/place.ts']
          },
          { id:'api-places-id', name:'[id]/route.ts', icon:'ğŸª', badge:'api',
            path:'app/api/places/[id]/route.ts',
            role:'GET â€” single place with full details.',
            exports:['GET'],
            connects:['lib/supabase/server.ts'],
            desc:'Returns full place data including hours (JSON), full discount description, menu items, and computed avg_rating.'
          },
          { id:'api-places-menu', name:'[id]/menu/route.ts', icon:'ğŸ¹', badge:'api',
            path:'app/api/places/[id]/menu/route.ts',
            role:'GET â€” all menu items for a place, with student prices.',
            exports:['GET'],
            connects:['lib/supabase/server.ts','types/menuItem.ts'],
            desc:'Returns the full menu_items list for a place. Each item has both price and student_price fields. Frontend shows both with student price highlighted.'
          },
        ]},

        { id:'api-orders', name:'orders/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-orders-create', name:'route.ts', icon:'ğŸ›’', badge:'api',
            path:'app/api/orders/route.ts',
            role:'POST â€” creates an order + Stripe PaymentIntent.',
            desc:'The most complex route. Validates the cart items against DB prices (never trust client prices). Applies student discount. Creates an order record with status="pending". Creates a Stripe PaymentIntent for the total. Returns client_secret to the frontend for Stripe.js to complete payment.',
            code:`<span class="comment">// 1. Validate items + prices from DB</span>
<span class="comment">// 2. Calculate discount</span>
<span class="comment">// 3. Insert order (status: pending)</span>
<span class="comment">// 4. Create Stripe PaymentIntent</span>
<span class="comment">// 5. Return { orderId, clientSecret }</span>`,
            exports:['POST'],
            connects:['lib/stripe/client.ts','lib/supabase/server.ts','types/order.ts']
          },
          { id:'api-orders-confirm', name:'[id]/confirm/route.ts', icon:'âœ”ï¸', badge:'api',
            path:'app/api/orders/[id]/confirm/route.ts',
            role:'POST â€” triggered by Stripe webhook. Submits order to Toast POS.',
            desc:'After Stripe confirms payment, the webhook fires this. It updates order status to "paid", then calls the Toast API to submit the order to the restaurant\'s POS system. Updates status to "sent" on success.',
            exports:['POST'],
            connects:['lib/toast/client.ts','lib/supabase/server.ts']
          },
          { id:'api-orders-history', name:'history/route.ts', icon:'ğŸ“‹', badge:'api',
            path:'app/api/orders/history/route.ts',
            role:'GET â€” returns current user\'s order history.',
            exports:['GET'],
            connects:['lib/supabase/server.ts'],
            desc:'Returns all orders for the authenticated user, ordered by created_at desc. Joins with place name for display.'
          },
        ]},

        { id:'api-reviews', name:'reviews/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-reviews-create', name:'route.ts', icon:'â­', badge:'api',
            path:'app/api/reviews/route.ts',
            role:'POST â€” submit a review. Triggers reward check.',
            desc:'Inserts a review record. Then increments the user\'s review_count and re-calculates place avg_rating. After insert, calls the RewardService to check if the user has hit a milestone (e.g. every 5 reviews = $5 reward).',
            exports:['POST','GET'],
            connects:['lib/supabase/server.ts','lib/rewards/rewardService.ts','lib/stripe/client.ts']
          },
        ]},

        { id:'api-users', name:'users/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-users-me', name:'me/route.ts', icon:'ğŸ‘¤', badge:'api',
            path:'app/api/users/me/route.ts',
            role:'GET/PUT â€” fetch or update the current user\'s profile.',
            exports:['GET','PUT'],
            connects:['lib/supabase/server.ts','types/user.ts'],
            desc:'GET returns user profile including edu_verified, review_count, rewards_balance. PUT updates display_name or personal_email.'
          },
        ]},

        { id:'api-rewards', name:'rewards/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-rewards-list', name:'route.ts', icon:'ğŸ', badge:'api',
            path:'app/api/rewards/route.ts',
            role:'GET â€” returns all rewards (earned + redeemed) for the user.',
            exports:['GET'],
            connects:['lib/supabase/server.ts','types/reward.ts'],
            desc:'Returns the user\'s full reward history with each $5 discount code and its redemption status.'
          },
        ]},

        { id:'api-webhooks', name:'webhooks/', icon:'ğŸ“', type:'folder', children:[
          { id:'api-stripe-webhook', name:'stripe/route.ts', icon:'âš¡', badge:'api',
            path:'app/api/webhooks/stripe/route.ts',
            role:'POST â€” receives Stripe webhook events (payment_intent.succeeded).',
            desc:'CRITICAL: Must verify Stripe webhook signature before processing. On payment_intent.succeeded, finds the matching order and calls the confirm flow â†’ Toast submission. This is the secure server-to-server path â€” never trust the client to confirm payment.',
            code:`<span class="comment">// ALWAYS verify signature first</span>
stripe.webhooks.constructEvent(body, sig, secret)

<span class="keyword">if</span> (event.type === <span class="string">'payment_intent.succeeded'</span>) {
  <span class="fn">confirmOrderAndSubmitToToast</span>(orderId)
}`,
            exports:['POST'],
            connects:['lib/stripe/client.ts','lib/toast/client.ts','lib/supabase/server.ts']
          },
        ]},

      ]},
    ]},

    { id:'components', name:'components/', icon:'ğŸ“', type:'folder', children:[
      { id:'comp-providers', name:'providers/', icon:'ğŸ“', type:'folder', children:[
        { id:'auth-provider', name:'AuthProvider.tsx', icon:'ğŸ”', badge:'ui',
          path:'components/providers/AuthProvider.tsx',
          role:'Wraps the app. Listens for Supabase auth state changes and syncs to Zustand.',
          desc:'Uses supabase.auth.onAuthStateChange to keep the global auth store in sync. If a user logs out in another tab, this picks it up.',
          exports:['AuthProvider'],
          connects:['lib/supabase/client.ts','store/useAuthStore']
        },
      ]},
      { id:'comp-map', name:'map/', icon:'ğŸ“', type:'folder', children:[
        { id:'map-view', name:'MapView.tsx', icon:'ğŸ—ºï¸', badge:'ui',
          path:'components/map/MapView.tsx',
          role:'Core Google Maps component. Renders markers for all places.',
          desc:'Loads the Google Maps JS SDK via @vis.gl/react-google-maps. Renders PlaceMarker for each place. On marker click, opens the PlaceDrawer. Exposes onBoundsChange callback so the parent page can refetch places when user pans/zooms.',
          exports:['MapView'],
          connects:['components/map/PlaceMarker','components/map/PlaceDrawer','lib/maps/utils.ts']
        },
        { id:'place-drawer', name:'PlaceDrawer.tsx', icon:'ğŸ“‹', badge:'ui',
          path:'components/map/PlaceDrawer.tsx',
          role:'Slide-up panel when a map marker is tapped. Shows place summary + actions.',
          desc:'Shows place name, discount badge, rating, category, hours, and two CTAs: "View Menu & Order" and "Get Directions". Get Directions constructs a Google Maps app deep link using place coordinates.',
          exports:['PlaceDrawer'],
          connects:['components/map/MapView','app/places/[id]/page.tsx','lib/maps/utils.ts']
        },
        { id:'filter-bar', name:'FilterBar.tsx', icon:'ğŸ”½', badge:'ui',
          path:'components/map/FilterBar.tsx',
          role:'Category filter pills â€” Drinks, Food, Coffee, etc.',
          exports:['FilterBar'],
          connects:['app/map/page.tsx'],
          desc:'Horizontal scrollable row of filter pills. On click, updates the category state in the parent which re-queries the API.'
        },
      ]},
      { id:'comp-order', name:'order/', icon:'ğŸ“', type:'folder', children:[
        { id:'cart', name:'Cart.tsx', icon:'ğŸ›’', badge:'ui',
          path:'components/order/Cart.tsx',
          role:'Cart sidebar. Shows items, student discounts applied, and total.',
          exports:['Cart'],
          connects:['store/useCartStore','components/order/CheckoutButton'],
          desc:'Reads from the Zustand cart store. Shows each item with both regular and student price. Total shows savings. Houses the CheckoutButton.'
        },
        { id:'checkout-btn', name:'CheckoutButton.tsx', icon:'ğŸ’³', badge:'ui',
          path:'components/order/CheckoutButton.tsx',
          role:'Stripe payment button â€” triggers PaymentIntent creation and Stripe Elements.',
          exports:['CheckoutButton'],
          connects:['app/api/orders/route.ts','lib/stripe/client.ts'],
          desc:'On click: calls POST /api/orders to get a clientSecret, then renders Stripe Elements payment sheet. On payment confirmation, waits for webhook to confirm before showing success.'
        },
      ]},
      { id:'comp-place', name:'place/', icon:'ğŸ“', type:'folder', children:[
        { id:'menu-grid', name:'MenuGrid.tsx', icon:'ğŸ¹', badge:'ui',
          path:'components/place/MenuGrid.tsx',
          role:'Grid of menu items with both regular and student price.',
          exports:['MenuGrid'],
          connects:['store/useCartStore','types/menuItem.ts'],
          desc:'Renders menu items in a grid. Each card shows name, image, regular price struck through, and student price highlighted in green. "Add to Cart" button updates Zustand cart store.'
        },
        { id:'review-list', name:'ReviewList.tsx', icon:'â­', badge:'ui',
          path:'components/place/ReviewList.tsx',
          role:'Reviews list with star ratings and "Write a Review" form.',
          exports:['ReviewList','ReviewForm'],
          connects:['app/api/reviews/route.ts','types/review.ts'],
          desc:'Shows existing reviews. If user is authenticated and hasn\'t reviewed this place, shows a ReviewForm below the list. Submitting triggers a POST /api/reviews.'
        },
      ]},
    ]},

    { id:'lib', name:'lib/', icon:'ğŸ“', type:'folder', children:[
      { id:'lib-supabase', name:'supabase/', icon:'ğŸ“', type:'folder', children:[
        { id:'supabase-client', name:'client.ts', icon:'ğŸ”Œ', badge:'svc',
          path:'lib/supabase/client.ts',
          role:'Supabase browser client â€” for client components.',
          desc:'Creates and exports a singleton Supabase client for use in React client components. Uses NEXT_PUBLIC env vars.',
          exports:['supabase (createBrowserClient)'],
          connects:['components/providers/AuthProvider','store/useAuthStore']
        },
        { id:'supabase-server', name:'server.ts', icon:'ğŸ–¥ï¸', badge:'svc',
          path:'lib/supabase/server.ts',
          role:'Supabase server client â€” for API routes and server components.',
          desc:'Creates a Supabase client that reads cookies for session context. Used in all API routes and server-rendered pages. Required to get the authenticated user server-side.',
          exports:['createServerClient'],
          connects:['app/api/*']
        },
      ]},
      { id:'lib-stripe', name:'stripe/', icon:'ğŸ“', type:'folder', children:[
        { id:'stripe-client', name:'client.ts', icon:'ğŸ’³', badge:'svc',
          path:'lib/stripe/client.ts',
          role:'Stripe SDK initialization and helper functions.',
          desc:'Initializes Stripe with the secret key (server-side only). Exports helper functions: createPaymentIntent(amount, metadata), createCoupon(value), retrievePaymentIntent(id).',
          exports:['stripe','createPaymentIntent','createCoupon'],
          connects:['app/api/orders/route.ts','app/api/webhooks/stripe/route.ts','lib/rewards/rewardService.ts']
        },
      ]},
      { id:'lib-toast', name:'toast/', icon:'ğŸ“', type:'folder', children:[
        { id:'toast-client', name:'client.ts', icon:'ğŸ', badge:'svc',
          path:'lib/toast/client.ts',
          role:'Toast POS API client â€” submits orders to restaurant POS systems.',
          desc:'Wraps the Toast REST API. Exports submitOrder(toastRestaurantId, orderPayload) which maps our internal order format to Toast\'s order schema. Handles auth headers and error responses.',
          exports:['submitOrderToToast','getToastMenu'],
          connects:['app/api/orders/[id]/confirm/route.ts']
        },
      ]},
      { id:'lib-email', name:'email/', icon:'ğŸ“', type:'folder', children:[
        { id:'resend-client', name:'resend.ts', icon:'ğŸ“§', badge:'svc',
          path:'lib/email/resend.ts',
          role:'Resend email client â€” sends transactional emails.',
          desc:'Initializes Resend with API key. Exports sendEduVerification(email, token), sendOrderConfirmation(email, order), sendRewardEarned(email, reward). Email templates are inline React Email components.',
          exports:['sendEduVerification','sendOrderConfirmation','sendRewardEarned'],
          connects:['app/api/auth/edu-verify/route.ts','lib/rewards/rewardService.ts']
        },
      ]},
      { id:'lib-rewards', name:'rewards/', icon:'ğŸ“', type:'folder', children:[
        { id:'reward-service', name:'rewardService.ts', icon:'ğŸ', badge:'svc',
          path:'lib/rewards/rewardService.ts',
          role:'Business logic for reward milestones and $5 discount generation.',
          desc:'Called after every review submission. Checks if the user\'s new review_count hits a milestone (e.g. 5, 10, 15...). If so: creates a Stripe coupon for $5, inserts a reward record in DB, sends a reward email via Resend.',
          code:`<span class="keyword">const</span> MILESTONE = <span class="type">5</span> <span class="comment">// every 5 reviews</span>
<span class="keyword">if</span> (reviewCount % MILESTONE === <span class="type">0</span>) {
  <span class="keyword">const</span> coupon = <span class="keyword">await</span> <span class="fn">createCoupon</span>(<span class="type">5</span>)
  <span class="keyword">await</span> <span class="fn">insertReward</span>(userId, coupon.id)
  <span class="keyword">await</span> <span class="fn">sendRewardEarned</span>(email, coupon)
}`,
          exports:['checkAndIssueReward'],
          connects:['lib/stripe/client.ts','lib/email/resend.ts','lib/supabase/server.ts']
        },
      ]},
      { id:'lib-maps', name:'maps/', icon:'ğŸ“', type:'folder', children:[
        { id:'maps-utils', name:'utils.ts', icon:'ğŸ“', badge:'svc',
          path:'lib/maps/utils.ts',
          role:'Google Maps helper utilities.',
          desc:'getDirectionsUrl(lat, lng, name) â€” builds a deep link to Google Maps for directions. getMapBounds(map) â€” extracts NE/SW bounds for API queries. formatPlaceMarker(place) â€” converts our place schema to a Maps marker config.',
          exports:['getDirectionsUrl','getMapBounds','formatPlaceMarker'],
          connects:['components/map/MapView','components/map/PlaceDrawer']
        },
      ]},
    ]},

    { id:'store', name:'store/', icon:'ğŸ“', type:'folder', children:[
      { id:'auth-store', name:'useAuthStore.ts', icon:'ğŸ”', badge:'svc',
        path:'store/useAuthStore.ts',
        role:'Zustand store â€” global auth state (user, session, edu_verified).',
        desc:'Holds the current Supabase session and user object. Exposes setUser, setSession, clearAuth. Synced by AuthProvider on mount and on every auth state change.',
        exports:['useAuthStore'],
        connects:['components/providers/AuthProvider','app/api/*']
      },
      { id:'cart-store', name:'useCartStore.ts', icon:'ğŸ›’', badge:'svc',
        path:'store/useCartStore.ts',
        role:'Zustand store â€” cart items, quantities, and computed totals.',
        desc:'Manages cart state: items[], addItem(item), removeItem(id), clearCart(), and computed selectors: cartTotal, cartTotalWithDiscount, itemCount. Cart is per-place (can\'t mix items from different restaurants).',
        exports:['useCartStore'],
        connects:['components/order/Cart','components/place/MenuGrid']
      },
    ]},

    { id:'types', name:'types/', icon:'ğŸ“', type:'folder', children:[
      { id:'type-user', name:'user.ts', icon:'ğŸ“', badge:'type',
        path:'types/user.ts',
        role:'TypeScript type definitions for User.',
        exports:['User','UserProfile'],
        connects:['everywhere'],
        desc:'Defines the User interface matching the DB schema. Also UserProfile (public-safe subset) and OnboardingState type.'
      },
      { id:'type-place', name:'place.ts', icon:'ğŸ“', badge:'type',
        path:'types/place.ts',
        role:'TypeScript type definitions for Place.',
        exports:['Place','PlaceCategory','PlaceMarker'],
        connects:['everywhere'],
        desc:'Place interface with all fields. PlaceCategory enum (drinks, food, coffee, etc.). PlaceMarker is a lightweight type for rendering map pins.'
      },
      { id:'type-order', name:'order.ts', icon:'ğŸ“', badge:'type',
        path:'types/order.ts',
        role:'TypeScript type definitions for Order and OrderItem.',
        exports:['Order','OrderItem','OrderStatus','CartItem'],
        connects:['everywhere'],
        desc:'Full Order type. OrderStatus is "pending" | "paid" | "sent" | "failed". CartItem is the runtime cart representation before an order is created.'
      },
      { id:'type-review', name:'review.ts', icon:'ğŸ“', badge:'type', exports:['Review'], connects:['app/api/reviews/*','components/place/ReviewList'] },
      { id:'type-reward', name:'reward.ts', icon:'ğŸ“', badge:'type', exports:['Reward'], connects:['app/api/rewards/*','lib/rewards/rewardService.ts'] },
    ]},

    { id:'supabase-dir', name:'supabase/', icon:'ğŸ“', type:'folder', children:[
      { id:'migrations', name:'migrations/', icon:'ğŸ“', type:'folder', children:[
        { id:'migration-init', name:'001_initial_schema.sql', icon:'ğŸ—„ï¸', badge:'db',
          path:'supabase/migrations/001_initial_schema.sql',
          role:'Initial DB migration â€” creates all tables, indexes, and RLS policies.',
          desc:'Creates: users, places, menu_items, orders, reviews, rewards tables. Sets up Row Level Security policies so users can only read their own orders/rewards. Creates indexes on (places.lat, places.lng) for map queries.',
          code:`<span class="keyword">CREATE TABLE</span> places (
  id uuid <span class="keyword">DEFAULT</span> gen_random_uuid(),
  name text <span class="keyword">NOT NULL</span>,
  lat numeric, lng numeric,
  category text[],
  pos_type text,
  ...
);

<span class="comment">-- Row Level Security</span>
<span class="keyword">ALTER TABLE</span> orders <span class="keyword">ENABLE ROW LEVEL SECURITY</span>;
<span class="keyword">CREATE POLICY</span> <span class="string">"own orders only"</span>
  <span class="keyword">ON</span> orders <span class="keyword">FOR ALL USING</span> (user_id = auth.uid());`,
          exports:['SQL migration'],
          connects:['lib/supabase/server.ts','lib/supabase/client.ts']
        },
        { id:'seed', name:'seed.sql', icon:'ğŸŒ±', badge:'db',
          path:'supabase/seed.sql',
          role:'Seed data â€” 10 sample Chicago spots with drinks discounts for dev/testing.',
          exports:['SQL seed data'],
          connects:['supabase/migrations/001_initial_schema.sql'],
          desc:'Inserts 10 real Chicago coffee shops and drink spots with fake but realistic discount data, coordinates, and menu items. Used for local development so you always have something on the map.'
        },
      ]},
    ]},

    { id:'middleware', name:'middleware.ts', icon:'ğŸ›¡ï¸', badge:'cfg',
      path:'middleware.ts',
      role:'Next.js middleware â€” route protection. Redirects unauthenticated users.',
      desc:'Runs on every request before the page renders. Checks for a valid Supabase session. If no session â†’ redirect to /. If session but not edu_verified â†’ redirect to /onboarding. Protects /map, /orders, /profile routes.',
      code:`<span class="comment">// Protected routes</span>
<span class="keyword">const</span> PROTECTED = [<span class="string">'/map'</span>, <span class="string">'/orders'</span>, <span class="string">'/profile'</span>]

<span class="keyword">if</span> (!session) redirect(<span class="string">'/'</span>)
<span class="keyword">if</span> (!edu_verified) redirect(<span class="string">'/onboarding'</span>)`,
      exports:['middleware','config'],
      connects:['lib/supabase/server.ts','app/*']
    },

    { id:'env', name:'.env.local', icon:'ğŸ”‘', badge:'cfg',
      path:'.env.local',
      role:'Environment variables â€” API keys and secrets. NEVER commit this file.',
      desc:'Contains all secret keys. Must be added to Vercel env vars for deployment.',
      code:`NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=
STRIPE_SECRET_KEY=
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_WEBHOOK_SECRET=
RESEND_API_KEY=
TOAST_API_KEY=`,
      exports:['env vars'],
      connects:['all lib/* clients']
    },

    { id:'next-config', name:'next.config.ts', icon:'âš™ï¸', badge:'cfg',
      path:'next.config.ts',
      role:'Next.js configuration â€” image domains, env validation.',
      exports:['nextConfig'],
      connects:['build system'],
      desc:'Configures allowed image domains (for Supabase storage). Sets up any required headers for Stripe webhooks (raw body access).'
    },

    { id:'package', name:'package.json', icon:'ğŸ“¦', badge:'cfg',
      path:'package.json',
      role:'Dependencies manifest.',
      code:`<span class="comment">// Key dependencies</span>
<span class="string">"next"</span>: <span class="string">"^14"</span>
<span class="string">"@supabase/ssr"</span>: latest
<span class="string">"@vis.gl/react-google-maps"</span>: latest
<span class="string">"stripe"</span>: latest
<span class="string">"@stripe/stripe-js"</span>: latest
<span class="string">"resend"</span>: latest
<span class="string">"zustand"</span>: latest
<span class="string">"@tanstack/react-query"</span>: latest
<span class="string">"tailwindcss"</span>: latest`,
      exports:['deps'],
      connects:['everything']
    },

  ]},
];

// â”€â”€ Flatten all file nodes for detail lookup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fileMap = {};
function flatten(nodes) {
  nodes.forEach(n => {
    if (n.id) fileMap[n.id] = n;
    if (n.children) flatten(n.children);
  });
}
flatten(tree);

// â”€â”€ Build tree HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTree(nodes, depth = 0) {
  return nodes.map(node => {
    const isFolder = node.type === 'folder' || node.type === 'root' || (node.children && node.children.length);
    const indent = depth * 16;
    const hasDetail = node.role || node.desc || node.code;

    const badgeHtml = node.badge ? `<span class="node-badge badge-${node.badge}">${node.badge}</span>` : '';
    const toggleHtml = isFolder ? `<span class="toggle-icon" id="toggle-${node.id}">â–¶</span>` : `<span style="min-width:12px;display:inline-block"></span>`;
    const nameClass = isFolder ? (depth === 0 ? 'node-name root' : 'node-name folder') : 'node-name';

    const row = `<div class="tree-node-row" id="row-${node.id}" onclick="handleClick('${node.id}', ${isFolder})" style="padding-left:${16 + indent}px">
      ${toggleHtml}
      <span class="node-icon">${node.icon || 'ğŸ“„'}</span>
      <span class="${nameClass}">${node.name}</span>
      ${badgeHtml}
    </div>`;

    if (isFolder && node.children) {
      const children = `<div class="tree-children" id="children-${node.id}">${renderTree(node.children, depth + 1)}</div>`;
      return `<div class="tree-node">${row}${children}</div>`;
    }
    return `<div class="tree-node">${row}</div>`;
  }).join('');
}

document.getElementById('tree').innerHTML = renderTree(tree);

// Auto-open root
document.getElementById('children-root').classList.add('open');
document.getElementById('toggle-root').classList.add('open');

// â”€â”€ Handle clicks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleClick(id, isFolder) {
  if (isFolder) {
    const ch = document.getElementById(`children-${id}`);
    const tog = document.getElementById(`toggle-${id}`);
    if (ch) { ch.classList.toggle('open'); tog.classList.toggle('open'); }
    return;
  }
  showDetail(id);
}

function showDetail(id) {
  // Clear active
  document.querySelectorAll('.tree-node-row').forEach(r => r.classList.remove('active'));
  document.getElementById(`row-${id}`)?.classList.add('active');

  const node = fileMap[id];
  if (!node) return;

  document.getElementById('empty-state').style.display = 'none';

  // Remove old detail
  document.querySelectorAll('.detail-content').forEach(d => d.remove());

  const panel = document.getElementById('detail');

  const exportsHtml = (node.exports || []).map(e =>
    `<div class="export-item"><span class="export-name">${e}</span></div>`
  ).join('');

  const connectsHtml = (node.connects || []).map(c =>
    `<span class="connect-tag">${c}</span>`
  ).join('');

  const codeHtml = node.code ? `
    <div class="detail-section">
      <div class="detail-section-title">Code Shape</div>
      <div class="code-block">${node.code}</div>
    </div>` : '';

  const desc2Html = node.desc2 ? `<p style="margin-top:10px;color:var(--muted2)">${node.desc2}</p>` : '';

  const div = document.createElement('div');
  div.className = 'detail-content active';
  div.innerHTML = `
    <div class="detail-path">${node.path || ''}</div>
    <div class="detail-filename">${node.name}</div>
    <div class="detail-role">${node.role || ''}</div>

    ${node.desc ? `<div class="detail-section">
      <div class="detail-section-title">What This File Does</div>
      <div class="detail-desc">${node.desc}${desc2Html}</div>
    </div>` : ''}

    ${codeHtml}

    ${node.exports?.length ? `<div class="detail-section">
      <div class="detail-section-title">Exports</div>
      <div class="exports-list">${exportsHtml}</div>
    </div>` : ''}

    ${node.connects?.length ? `<div class="detail-section">
      <div class="detail-section-title">Connects To</div>
      <div class="connects-grid">${connectsHtml}</div>
    </div>` : ''}
  `;
  panel.appendChild(div);
  panel.scrollTop = 0;
}
</script>
</body>
</html>